<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WatermarkRemover.ai - Remove Watermarks with AI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <header class="app-header container">
        <a href="index.html" class="logo" aria-label="WatermarkRemover.ai Homepage">
            <svg width="32" height="32" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <circle cx="20" cy="20" r="19" class="logo-outline" />
                <circle cx="20" cy="20" r="4" class="logo-dot" />
            </svg>
            <span>WatermarkRemover.ai</span>
        </a>
        <button class="login-btn" onclick="showLogin()">
            <i class="fa-solid fa-right-to-bracket"></i>
            Login / Sign Up
        </button>
    </header>

    <main class="container">
        <section class="hero-section">
            <h1>Erase Watermarks with a <span class="sparkle">Sparkle</span></h1>
            <p>Our AI magically removes unwanted objects, text, and logos from your images in seconds. Get 3 free removals per day!</p>
            <div class="uploader-wrapper">
                <div class="tabs">
                    <button class="tab active" id="autoTab" onclick="setActiveTab('auto')">
                        Auto Remove
                    </button>
                    <button class="tab" id="manualTab" onclick="setActiveTab('manual')">
                        Manual Brush <span class="new-badge">PRO</span>
                    </button>
                </div>
                <div id="uploaderContainer">
                    <div class="uploader-container" onclick="document.getElementById('fileInput').click()">
                        <input type="file" id="fileInput" style="display: none;" accept="image/jpeg,image/png,image/webp" />
                        <p>Drag & drop your image here, or</p>
                        <button class="upload-btn">
                            <i class="fa-solid fa-upload"></i>
                            Choose File
                        </button>
                        <p class="file-formats">Supports: <span>JPG</span> <span>PNG</span> <span>WEBP</span></p>
                    </div>
                </div>
                <div id="loader" class="loader-container" style="display: none;">
                    <div class="loader"></div>
                    <p>AI is working its magic...</p>
                </div>
                <div id="error" class="error-message" style="display: none;"></div>
            </div>
        </section>

        <div id="resultSection" class="results-section" style="display: none;">
            <h2>Your Image is Ready!</h2>
            <p>Slide to compare the original and the result.</p>
            <div class="comparison-container" id="comparisonContainer">
                <img id="resultImg" alt="Result" class="comparison-image" />
                <div class="image-original-wrapper" id="originalWrapper">
                    <img id="originalImg" alt="Original" class="comparison-image" />
                </div>
                <div class="comparison-slider" id="comparisonSlider">
                    <div class="slider-handle">
                        <i class="fa-solid fa-arrows-left-right"></i>
                    </div>
                </div>
            </div>
            <div class="actions">
                <button id="downloadBtn" class="download-btn">
                    <i class="fa-solid fa-download"></i> Download Image
                </button>
                <button onclick="resetApp()" class="reset-btn">
                    <i class="fa-solid fa-arrow-rotate-left"></i> Remove Another
                </button>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-functions.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDoPA_WaSKW18QGvCnNNvXpL_G_kRtk46U",
            authDomain: "ai-watermark-backend-2024.firebaseapp.com",
            projectId: "ai-watermark-backend-2024",
            storageBucket: "ai-watermark-backend-2024.firebasestorage.app",
            messagingSenderId: "550066139623",
            appId: "1:550066139623:web:fa14b1be84dbe8a39f4d42"
        };

        const app = initializeApp(firebaseConfig);
        const functions = getFunctions(app);
        const auth = getAuth(app);

        let activeTab = 'auto';
        let originalImageData = null;
        let resultImageData = null;

        // Setup file input handler
        document.getElementById('fileInput').addEventListener('change', handleFileChange);

        window.setActiveTab = function(tab) {
            activeTab = tab;
            document.getElementById('autoTab').classList.toggle('active', tab === 'auto');
            document.getElementById('manualTab').classList.toggle('active', tab === 'manual');
        };

        window.showLogin = async function() {
            try {
                const provider = new GoogleAuthProvider();
                const result = await signInWithPopup(auth, provider);
                alert('Logged in as: ' + result.user.email);
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        };

        window.resetApp = function() {
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('uploaderContainer').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('fileInput').value = '';
            originalImageData = null;
            resultImageData = null;
        };

        async function handleFileChange(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!['image/jpeg', 'image/png', 'image/webp'].includes(file.type)) {
                showError('Unsupported format. Please upload a JPG, PNG, or WEBP file.');
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const dataUrl = e.target.result;
                const base64Data = dataUrl.split(',')[1];
                originalImageData = dataUrl;
                
                if (activeTab === 'auto') {
                    await processWithAI(base64Data, file.type);
                } else {
                    alert('Manual brush mode coming soon!');
                }
            };
            reader.readAsDataURL(file);
        }

        async function processWithAI(base64Data, mimeType) {
            showLoader(true);
            hideError();

            try {
                const removeWatermarkCallable = httpsCallable(functions, 'removeWatermarkWithAI');
                const response = await removeWatermarkCallable({
                    parts: [
                        { inlineData: { data: base64Data, mimeType: mimeType } },
                        { text: 'Completely remove any watermarks, logos, or text from this image. Intelligently reconstruct the background where the elements were removed to create a clean, natural-looking photo.' }
                    ]
                });

                const { data, mimeType: resultMimeType, remainingCredits } = response.data;
                resultImageData = `data:${resultMimeType};base64,${data}`;
                
                showResult();
                
                if (remainingCredits >= 0) {
                    console.log(`Remaining attempts: ${remainingCredits}`);
                }
                
            } catch (err) {
                let message = 'An error occurred while processing the image.';
                if (err.code === 'functions/permission-denied') {
                    message = 'Free attempts exhausted. Please sign in or upgrade to Pro!';
                } else if (err.message) {
                    message = err.message;
                }
                showError(message);
            } finally {
                showLoader(false);
            }
        }

        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'block' : 'none';
            document.getElementById('uploaderContainer').style.display = show ? 'none' : 'block';
        }

        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        function showResult() {
            document.getElementById('originalImg').src = originalImageData;
            document.getElementById('resultImg').src = resultImageData;
            document.getElementById('resultSection').style.display = 'block';
            
            // Setup download
            document.getElementById('downloadBtn').onclick = function() {
                const link = document.createElement('a');
                link.href = resultImageData;
                link.download = 'watermark-removed.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
            
            // Scroll to result
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>